<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <title>AI Chat</title>
    <link rel="stylesheet" href="/style.css" />

    <style>
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            border-bottom: 1px solid #2a2b32;
        }
        
        .user-info {
            display: flex;
            gap: 8px;
            align-items: center;
            font-size: 13px;
            color: #9ca3af;
        }
        
        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #10a37f;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }
        
        .actions {
            display: flex;
            gap: 8px;
        }
        
        .login-btn,
        .clear-btn {
            background: #10a37f;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
        }
        
        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            display: none;
        }
        
        .clear-btn {
            background: #334155;
            display: none;
        }
        
        .guest-note {
            text-align: center;
            font-size: 12px;
            color: #9ca3af;
            padding: 6px;
        }
    </style>
</head>

<body>
    <div class="container">

        <!-- HEADER -->
        <div class="header">
            <div class="user-info">
                <div class="avatar" id="avatar">G</div>
                <span id="user">Guest</span>
            </div>

            <h3>ü§ñ AI Chat</h3>

            <div class="actions">
                <button class="clear-btn" id="clearBtn" onclick="clearHistory()">üóë</button>
                <button class="login-btn" id="loginBtn" onclick="goLogin()">ƒêƒÉng nh·∫≠p</button>
                <button class="logout-btn" id="logoutBtn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>

        <div class="guest-note" id="guestNote"></div>

        <!-- CHAT -->
        <div id="chatBox" class="chat-box"></div>

        <!-- INPUT -->
        <div class="input-area">
            <input id="input" placeholder="Nh·∫≠p c√¢u h·ªèi..." />
            <button onclick="send()">‚û§</button>
        </div>

    </div>

    <script>
        const MAX_GUEST = 3;
        const RESET_TIME = 24 * 60 * 60 * 1000; // 24h

        const userEl = document.getElementById("user");
        const avatarEl = document.getElementById("avatar");
        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const clearBtn = document.getElementById("clearBtn");
        const guestNote = document.getElementById("guestNote");
        const input = document.getElementById("input");
        const chatBox = document.getElementById("chatBox");

        let token = localStorage.getItem("token");
        let username = localStorage.getItem("username");

        /* ===== GUEST RESET 24H ===== */
        function loadGuestCount() {
            let count = Number(localStorage.getItem("guestCount") || 0);
            let start = Number(localStorage.getItem("guestStartTime") || 0);

            if (!start) {
                localStorage.setItem("guestStartTime", Date.now());
                localStorage.setItem("guestCount", 0);
                return 0;
            }

            if (Date.now() - start >= RESET_TIME) {
                localStorage.setItem("guestStartTime", Date.now());
                localStorage.setItem("guestCount", 0);
                return 0;
            }

            return count;
        }

        let guestCount = loadGuestCount();

        /* ===== UI ===== */
        function updateUI() {
            token = localStorage.getItem("token");
            username = localStorage.getItem("username");
            guestCount = loadGuestCount();

            if (token && username) {
                userEl.innerText = username;
                avatarEl.innerText = username[0].toUpperCase();
                loginBtn.style.display = "none";
                logoutBtn.style.display = "inline-block";
                clearBtn.style.display = "inline-block";
                guestNote.innerText = "";
                input.disabled = false;
            } else {
                userEl.innerText = "Guest";
                avatarEl.innerText = "G";
                loginBtn.style.display = "inline-block";
                logoutBtn.style.display = "none";
                clearBtn.style.display = "none";
                guestNote.innerText =
                    `B·∫°n ƒëang d√πng Guest (${MAX_GUEST - guestCount}/${MAX_GUEST} c√¢u mi·ªÖn ph√≠)`;
                input.disabled = guestCount >= MAX_GUEST;
            }
        }

        updateUI();

        /* ===== HISTORY ===== */
        async function loadHistory() {
            if (!token) return;
            const res = await fetch("/history", {
                headers: {
                    Authorization: "Bearer " + token
                }
            });
            const history = await res.json();
            chatBox.innerHTML = "";
            history.forEach(m => {
                const div = document.createElement("div");
                div.className = "msg " + (m.role === "user" ? "user" : "ai");
                div.innerText = m.content;
                chatBox.appendChild(div);
            });
        }
        loadHistory();

        /* ===== AUTH ===== */
        function goLogin() {
            window.location.href = "/login.html";
        }

        function logout() {
            if (!confirm("ƒêƒÉng xu·∫•t?")) return;
            localStorage.removeItem("token");
            localStorage.removeItem("username");
            updateUI();
            chatBox.innerHTML = "";
        }

        /* ===== CLEAR HISTORY ===== */
        async function clearHistory() {
            if (!confirm("Xo√° to√†n b·ªô l·ªãch s·ª≠ chat?")) return;
            await fetch("/history", {
                method: "DELETE",
                headers: {
                    Authorization: "Bearer " + token
                }
            });
            chatBox.innerHTML = "";
        }

        /* ===== CHAT ===== */
        async function send() {
            const msg = input.value.trim();
            if (!msg) return;

            if (!token) {
                if (guestCount >= MAX_GUEST) {
                    alert("‚ö†Ô∏è B·∫°n ƒë√£ h·∫øt l∆∞·ª£t mi·ªÖn ph√≠. Vui l√≤ng ƒëƒÉng nh·∫≠p.");
                    goLogin();
                    return;
                }
                guestCount++;
                localStorage.setItem("guestCount", guestCount);
            }

            updateUI();

            chatBox.innerHTML += `<div class="msg user">${msg}</div>`;
            input.value = "";

            const ai = document.createElement("div");
            ai.className = "msg ai";
            ai.innerText = "ƒêang tr·∫£ l·ªùi...";
            chatBox.appendChild(ai);

            try {
                const res = await fetch("/chat", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        ...(token && {
                            Authorization: "Bearer " + token
                        })
                    },
                    body: JSON.stringify({
                        message: msg
                    })
                });
                const data = await res.json();
                ai.innerText = data.reply || "‚ùå L·ªói";
            } catch {
                ai.innerText = "‚ùå Kh√¥ng k·∫øt n·ªëi server";
            }

            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>

</html>