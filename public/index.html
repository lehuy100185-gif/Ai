<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>AI Chat</title>
    <link rel="stylesheet" href="/style.css">

    <style>
        /* ===== HEADER USER ===== */
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px;
            border-bottom: 1px solid #2a2b32;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #9ca3af;
        }
        
        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #10a37f;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 13px;
        }
        
        .logout-btn {
            background: transparent;
            border: 1px solid #374151;
            color: #9ca3af;
            font-size: 14px;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            transition: all .2s ease;
        }
        
        .logout-btn:hover {
            background: #ef4444;
            border-color: #ef4444;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">

        <!-- HEADER -->
        <div class="header">
            <div class="user-info">
                <div class="avatar" id="avatar">U</div>
                <span id="user">user</span>
            </div>

            <h2 style="margin:0;">ü§ñ AI Chat</h2>

            <button class="logout-btn" onclick="logout()" title="ƒêƒÉng xu·∫•t">
                ‚éã
            </button>
        </div>

        <!-- CHAT -->
        <div id="chatBox" class="chat-box"></div>

        <!-- INPUT -->
        <div class="input-area">
            <input id="input" placeholder="Nh·∫≠p c√¢u h·ªèi..." onkeydown="if(event.key==='Enter') send()">
            <button onclick="send()">‚û§</button>
        </div>

    </div>

    <script>
        /* ================= AUTH CHECK ================= */
        const token = localStorage.getItem("token");
        const username = localStorage.getItem("username");

        if (!token || !username) {
            window.location.href = "/login.html";
        }

        /* HI·ªÜN USER + AVATAR */
        document.getElementById("user").innerText = username;
        document.getElementById("avatar").innerText = username[0].toUpperCase();

        const chatBox = document.getElementById("chatBox");
        const input = document.getElementById("input");

        /* ================= LOAD / SAVE CHAT ================= */
        function saveChat() {
            localStorage.setItem("chatHistory", chatBox.innerHTML);
        }

        function loadChat() {
            const saved = localStorage.getItem("chatHistory");
            if (saved) chatBox.innerHTML = saved;
        }

        loadChat();

        /* ================= LOGOUT ================= */
        function logout() {
            if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) return;
            localStorage.clear();
            window.location.href = "/login.html";
        }

        /* ================= SEND ================= */
        async function send() {
            const msg = input.value.trim();
            if (!msg) return;

            const userDiv = document.createElement("div");
            userDiv.className = "msg user";
            userDiv.innerText = msg;
            chatBox.appendChild(userDiv);
            input.value = "";
            saveChat();

            const aiDiv = document.createElement("div");
            aiDiv.className = "msg ai";
            aiDiv.innerText = "ƒêang tr·∫£ l·ªùi...";
            chatBox.appendChild(aiDiv);

            try {
                const res = await fetch("/chat", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token
                    },
                    body: JSON.stringify({
                        message: msg
                    })
                });

                const data = await res.json();
                aiDiv.innerText = data.reply || "‚ùå L·ªói ph·∫£n h·ªìi";
            } catch {
                aiDiv.innerText = "‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi server";
            }

            chatBox.scrollTop = chatBox.scrollHeight;
            saveChat();
        }
    </script>

</body>

</html>